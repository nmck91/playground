<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Family Reward Chart</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(33, 128, 141, 1);
          --color-teal-600: rgba(29, 116, 128, 1);
          --color-teal-700: rgba(26, 104, 115, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);

          /* RGB versions for opacity control */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 33, 128, 141;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;

          /* Background color tokens (Light Mode) */
          --color-bg-1: rgba(59, 130, 246, 0.08); /* Light blue */
          --color-bg-2: rgba(245, 158, 11, 0.08); /* Light yellow */
          --color-bg-3: rgba(34, 197, 94, 0.08); /* Light green */
          --color-bg-4: rgba(239, 68, 68, 0.08); /* Light red */
          --color-bg-5: rgba(147, 51, 234, 0.08); /* Light purple */
          --color-bg-6: rgba(249, 115, 22, 0.08); /* Light orange */
          --color-bg-7: rgba(236, 72, 153, 0.08); /* Light pink */
          --color-bg-8: rgba(6, 182, 212, 0.08); /* Light cyan */

          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-teal-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

          /* Typography */
          --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
            BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
            Monaco, Consolas, monospace;
          --font-size-xs: 11px;
          --font-size-sm: 12px;
          --font-size-base: 14px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-size-xl: 18px;
          --font-size-2xl: 20px;
          --font-size-3xl: 24px;
          --font-size-4xl: 30px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 550;
          --font-weight-bold: 600;
          --line-height-tight: 1.2;
          --line-height-normal: 1.5;
          --letter-spacing-tight: -0.01em;

          /* Spacing */
          --space-0: 0;
          --space-1: 1px;
          --space-2: 2px;
          --space-4: 4px;
          --space-6: 6px;
          --space-8: 8px;
          --space-10: 10px;
          --space-12: 12px;
          --space-16: 16px;
          --space-20: 20px;
          --space-24: 24px;
          --space-32: 32px;

          /* Border Radius */
          --radius-sm: 6px;
          --radius-base: 8px;
          --radius-md: 10px;
          --radius-lg: 12px;
          --radius-full: 9999px;

          /* Shadows */
          --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
            0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
            0 4px 6px -2px rgba(0, 0, 0, 0.02);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
            inset 0 -1px 0 rgba(0, 0, 0, 0.03);

          /* Animation */
          --duration-fast: 150ms;
          --duration-normal: 250ms;
          --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

          /* Custom colors for children */
          --child-1-color: #87CEEB;
          --child-2-color: #90EE90;
          --child-3-color: #DDA0DD;
          --parent-color: #FFE55C;
        }

        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: var(--font-family-base);
          background-color: var(--color-background);
          color: var(--color-text);
          line-height: var(--line-height-normal);
        }

        .container {
          max-width: 1200px;
          margin: 0 auto;
          padding: var(--space-16);
        }

        .header {
          text-align: center;
          margin-bottom: var(--space-24);
        }

        .header h1 {
          font-size: var(--font-size-4xl);
          font-weight: var(--font-weight-bold);
          color: var(--color-primary);
          margin-bottom: var(--space-8);
        }

        .week-display {
          font-size: var(--font-size-lg);
          color: var(--color-text-secondary);
          margin-bottom: var(--space-16);
        }

        .controls {
          display: flex;
          gap: var(--space-12);
          justify-content: center;
          flex-wrap: wrap;
          margin-bottom: var(--space-24);
        }

        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--space-8) var(--space-16);
          border-radius: var(--radius-base);
          font-size: var(--font-size-base);
          font-weight: var(--font-weight-medium);
          cursor: pointer;
          transition: all var(--duration-normal) var(--ease-standard);
          border: none;
          text-decoration: none;
        }

        .btn--primary {
          background: var(--color-primary);
          color: var(--color-btn-primary-text);
        }

        .btn--primary:hover {
          background: var(--color-primary-hover);
        }

        .btn--secondary {
          background: var(--color-secondary);
          color: var(--color-text);
        }

        .btn--secondary:hover {
          background: var(--color-secondary-hover);
        }

        .section {
          background: var(--color-surface);
          border-radius: var(--radius-lg);
          box-shadow: var(--shadow-sm);
          margin-bottom: var(--space-24);
          overflow: hidden;
        }

        .section-header {
          padding: var(--space-16);
          background: var(--color-bg-1);
          border-bottom: 1px solid var(--color-border);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .section-header h2 {
          font-size: var(--font-size-2xl);
          font-weight: var(--font-weight-semibold);
        }

        .toggle-btn {
          background: none;
          border: none;
          font-size: var(--font-size-lg);
          cursor: pointer;
          color: var(--color-text-secondary);
          transition: color var(--duration-fast);
        }

        .toggle-btn:hover {
          color: var(--color-text);
        }

        .section-content {
          padding: var(--space-16);
        }

        .child-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
          gap: var(--space-16);
        }

        .child-card {
          background: var(--color-surface);
          border-radius: var(--radius-md);
          border: 2px solid;
          padding: var(--space-16);
          box-shadow: var(--shadow-sm);
        }

        .child-card.child-1 {
          border-color: var(--child-1-color);
          background: rgba(135, 206, 235, 0.1);
        }

        .child-card.child-2 {
          border-color: var(--child-2-color);
          background: rgba(144, 238, 144, 0.1);
        }

        .child-card.child-3 {
          border-color: var(--child-3-color);
          background: rgba(221, 160, 221, 0.1);
        }

        .child-card.parent {
          border-color: var(--parent-color);
          background: rgba(255, 229, 92, 0.1);
        }

        .child-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: var(--space-16);
        }

        .child-name {
          font-size: var(--font-size-xl);
          font-weight: var(--font-weight-semibold);
        }

        .child-total {
          font-size: var(--font-size-lg);
          font-weight: var(--font-weight-bold);
          color: var(--color-primary);
        }

        .habits-grid {
          display: grid;
          gap: var(--space-8);
        }

        .habit-row {
          display: grid;
          grid-template-columns: 1fr repeat(7, 40px);
          gap: var(--space-4);
          align-items: center;
          padding: var(--space-8);
          background: rgba(255, 255, 255, 0.5);
          border-radius: var(--radius-sm);
        }

        .habit-name {
          font-size: var(--font-size-sm);
          font-weight: var(--font-weight-medium);
        }

        .star-btn {
          width: 32px;
          height: 32px;
          border: none;
          background: none;
          cursor: pointer;
          font-size: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: var(--radius-sm);
          transition: all var(--duration-fast);
        }

        .star-btn:hover {
          background: rgba(255, 215, 0, 0.2);
          transform: scale(1.1);
        }

        .star-btn.filled {
          color: #FFD700;
        }

        .star-btn.empty {
          color: #DDD;
        }

        .days-header {
          display: grid;
          grid-template-columns: 1fr repeat(7, 40px);
          gap: var(--space-4);
          margin-bottom: var(--space-8);
          padding: 0 var(--space-8);
        }

        .day-label {
          font-size: var(--font-size-sm);
          font-weight: var(--font-weight-semibold);
          text-align: center;
          color: var(--color-text-secondary);
        }

        .progress-bar {
          width: 100%;
          height: 8px;
          background: rgba(0, 0, 0, 0.1);
          border-radius: var(--radius-full);
          overflow: hidden;
          margin-top: var(--space-8);
        }

        .progress-fill {
          height: 100%;
          background: var(--color-success);
          transition: width var(--duration-normal);
          border-radius: var(--radius-full);
        }

        .progress-text {
          font-size: var(--font-size-xs);
          color: var(--color-text-secondary);
          margin-top: var(--space-4);
          text-align: center;
        }

        .rewards-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          display: none;
          align-items: center;
          justify-content: center;
          padding: var(--space-16);
        }

        .rewards-modal {
          background: var(--color-surface);
          border-radius: var(--radius-lg);
          box-shadow: var(--shadow-lg);
          max-width: 800px;
          width: 100%;
          max-height: 80vh;
          overflow-y: auto;
        }

        .rewards-header {
          padding: var(--space-16);
          border-bottom: 1px solid var(--color-border);
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .rewards-content {
          padding: var(--space-16);
        }

        .rewards-section {
          margin-bottom: var(--space-24);
        }

        .rewards-section h3 {
          font-size: var(--font-size-xl);
          font-weight: var(--font-weight-semibold);
          margin-bottom: var(--space-12);
          color: var(--color-primary);
        }

        .rewards-grid {
          display: grid;
          gap: var(--space-8);
        }

        .reward-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: var(--space-12);
          background: var(--color-bg-1);
          border-radius: var(--radius-base);
          border-left: 4px solid var(--color-primary);
        }

        .reward-info {
          flex: 1;
        }

        .reward-name {
          font-weight: var(--font-weight-medium);
          margin-bottom: var(--space-4);
        }

        .reward-cost {
          font-size: var(--font-size-sm);
          color: var(--color-text-secondary);
        }

        .reward-stars {
          font-weight: var(--font-weight-bold);
          color: var(--color-primary);
        }

        .close-btn {
          background: none;
          border: none;
          font-size: var(--font-size-xl);
          cursor: pointer;
          color: var(--color-text-secondary);
          width: 32px;
          height: 32px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: var(--radius-sm);
        }

        .close-btn:hover {
          background: var(--color-secondary);
          color: var(--color-text);
        }

        .settings-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          display: none;
          align-items: center;
          justify-content: center;
          padding: var(--space-16);
        }

        .settings-modal {
          background: var(--color-surface);
          border-radius: var(--radius-lg);
          box-shadow: var(--shadow-lg);
          max-width: 500px;
          width: 100%;
        }

        .settings-content {
          padding: var(--space-16);
        }

        .form-group {
          margin-bottom: var(--space-16);
        }

        .form-label {
          display: block;
          margin-bottom: var(--space-8);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }

        .form-control {
          display: block;
          width: 100%;
          padding: var(--space-8) var(--space-12);
          font-size: var(--font-size-base);
          line-height: 1.5;
          color: var(--color-text);
          background-color: var(--color-surface);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          transition: border-color var(--duration-fast);
        }

        .form-control:focus {
          border-color: var(--color-primary);
          outline: 2px solid var(--color-primary);
        }

        .hidden {
          display: none !important;
        }

        .celebration {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          font-size: 4rem;
          z-index: 1001;
          animation: celebrate 0.6s ease-out;
          pointer-events: none;
        }

        @keyframes celebrate {
          0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
          50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        @media (max-width: 768px) {
          .container {
            padding: var(--space-8);
          }

          .child-grid {
            grid-template-columns: 1fr;
          }

          .header h1 {
            font-size: var(--font-size-2xl);
            margin-bottom: var(--space-4);
          }

          .week-display {
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-12);
          }

          .section {
            margin-bottom: var(--space-16);
          }

          .section-header {
            padding: var(--space-12);
          }

          .section-header h2 {
            font-size: var(--font-size-lg);
          }

          .section-content {
            padding: var(--space-12);
          }

          .child-card {
            padding: var(--space-12);
          }

          .child-name {
            font-size: var(--font-size-base);
          }

          .child-total {
            font-size: var(--font-size-base);
          }

          .habit-row {
            grid-template-columns: 1fr repeat(7, 28px);
            gap: var(--space-2);
            padding: var(--space-6);
          }

          .days-header {
            grid-template-columns: 1fr repeat(7, 28px);
            gap: var(--space-2);
          }

          .day-label {
            font-size: 10px;
          }

          .habit-name {
            font-size: 11px;
            line-height: 1.2;
          }

          .star-btn {
            width: 24px;
            height: 24px;
            font-size: 18px;
          }

          .controls {
            flex-direction: column;
            align-items: stretch;
            gap: var(--space-8);
          }

          .btn {
            width: 100%;
            padding: var(--space-12) var(--space-16);
          }

          .progress-text {
            font-size: 10px;
          }

          .rewards-modal {
            max-height: 90vh;
            margin: var(--space-8);
          }

          .rewards-header,
          .settings-content {
            padding: var(--space-12);
          }

          .rewards-content {
            padding: var(--space-12);
          }

          .rewards-section {
            margin-bottom: var(--space-16);
          }

          .rewards-section h3 {
            font-size: var(--font-size-base);
          }

          .reward-item {
            padding: var(--space-8);
            font-size: var(--font-size-sm);
          }

          .reward-name {
            font-size: var(--font-size-sm);
          }
        }

        @media (max-width: 480px) {
          .habit-row {
            grid-template-columns: 1fr repeat(7, 24px);
            gap: var(--space-1);
            padding: var(--space-4);
          }

          .days-header {
            grid-template-columns: 1fr repeat(7, 24px);
            gap: var(--space-1);
          }

          .day-label {
            font-size: 9px;
          }

          .habit-name {
            font-size: 10px;
          }

          .star-btn {
            width: 20px;
            height: 20px;
            font-size: 16px;
          }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü Our Family Reward Chart üåü</h1>
            <div class="week-display" id="weekDisplay">Week of October 21-27, 2024</div>
            <div class="controls">
                <button class="btn btn--primary" onclick="showRewards()">üéÅ View Rewards</button>
                <button class="btn btn--secondary" onclick="showSettings()">‚öôÔ∏è Settings</button>
                <button class="btn btn--secondary" onclick="newWeek()">üîÑ New Week</button>
            </div>
        </div>

        <!-- Kids Chart Section -->
        <div class="section">
            <div class="section-header">
                <h2>üë∂ Kids' Chart</h2>
            </div>
            <div class="section-content">
                <div class="child-grid" id="kidsGrid">
                    <!-- Kids cards will be generated here -->
                </div>
            </div>
        </div>

        <!-- Parents Chart Section -->
        <div class="section">
            <div class="section-header">
                <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Rate Mum &amp; Dad!</h2>
                <button class="toggle-btn" onclick="toggleParentsSection()">üìä</button>
            </div>
            <div class="section-content" id="parentsContent">
                <div class="child-grid" id="parentsGrid">
                    <!-- Parents cards will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Rewards Modal -->
    <div class="rewards-overlay" id="rewardsOverlay" onclick="hideRewards(event)">
        <div class="rewards-modal" onclick="event.stopPropagation()">
            <div class="rewards-header">
                <h2>üéÅ Reward Menu</h2>
                <button class="close-btn" onclick="hideRewards()">&times;</button>
            </div>
            <div class="rewards-content">
                <div class="rewards-section">
                    <h3>üßí Kids' Rewards</h3>
                    <div class="rewards-grid" id="kidsRewards">
                        <!-- Kids rewards will be generated here -->
                    </div>
                </div>
                <div class="rewards-section">
                    <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parents' Rewards</h3>
                    <div class="rewards-grid" id="parentsRewards">
                        <!-- Parents rewards will be generated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-overlay" id="settingsOverlay" onclick="hideSettings(event)">
        <div class="settings-modal" onclick="event.stopPropagation()">
            <div class="rewards-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="hideSettings()">&times;</button>
            </div>
            <div class="settings-content">
                <div class="form-group">
                    <label class="form-label">Child 1 Name:</label>
                    <input type="text" class="form-control" id="child1Name" value="Child 1 (Age 6)">
                </div>
                <div class="form-group">
                    <label class="form-label">Child 2 Name:</label>
                    <input type="text" class="form-control" id="child2Name" value="Child 2 (Age 7)">
                </div>
                <div class="form-group">
                    <label class="form-label">Child 3 Name:</label>
                    <input type="text" class="form-control" id="child3Name" value="Child 3 (Age 8)">
                </div>
                <div class="form-group">
                    <button class="btn btn--primary" onclick="saveSettings()">üíæ Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // TODO: Replace these with your actual Supabase credentials
        const SUPABASE_URL = 'https://wesqfkkkmhftxmcpslgj.supabase.co'; // e.g., 'https://xxxxx.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Fma2trbWhmdHhtY3BzbGdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzNjQ1MjIsImV4cCI6MjA3Nzk0MDUyMn0.w5YzndymLCdOzHPZYJ3BFwlTfMzQ563oYVznKDEnC5k'; // Your anon/public key

        // Initialize Supabase client
        let supabase = null;
        let familyMembers = {}; // Map member names to IDs from Supabase

        // Check if Supabase is configured
        const isSupabaseConfigured = () => {
            return SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY';
        };

        // Initialize Supabase if configured
        if (isSupabaseConfigured()) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('‚úÖ Supabase connected!');
        } else {
            console.warn('‚ö†Ô∏è Supabase not configured - running in local-only mode');
            console.warn('Edit index.html and add your Supabase URL and Key');
        }

        // ============================================
        // DATA STRUCTURE
        // ============================================
        // Data structure to hold all chart data
        let chartData = {
            children: [
                { name: "F√≠adh", color: "#87CEEB", className: "child-1" },
                { name: "S√©", color: "#90EE90", className: "child-2" },
                { name: "Niall √ìg", color: "#DDA0DD", className: "child-3" }
            ],
            parents: [
                { name: "Mum", color: "#FFE55C", className: "parent" },
                { name: "Dad", color: "#FFE55C", className: "parent" }
            ],
            kidsHabits: [
                "Brushing teeth (morning &amp; night)",
                "Tidying up after themselves",
                "Homework/Reading",
                "Being kind to siblings",
                "Using good manners"
            ],
            parentHabits: [
                "Playing with us when asked",
                "Not being grumpy in the morning",
                "Reading bedtime story with voices",
                "Making our favorite meal",
                "Taking us somewhere fun"
            ],
            days: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            kidsRewards: [
                { name: "Choose what's for dinner", cost: "FREE", stars: 20 },
                { name: "Trip to the park with parent", cost: "FREE", stars: 20 },
                { name: "Bike ride adventure", cost: "FREE", stars: 20 },
                { name: "Game night - child picks game", cost: "FREE", stars: 20 },
                { name: "Bubble play session", cost: "¬£1", stars: 20 },
                { name: "Nature walk &amp; treasure hunt", cost: "FREE", stars: 20 },
                { name: "Build a blanket fort together", cost: "FREE", stars: 20 },
                { name: "Picnic in garden/park", cost: "¬£3", stars: 22 },
                { name: "Choose family movie night film", cost: "FREE", stars: 25 },
                { name: "Extra 30 minutes stay up late", cost: "FREE", stars: 25 },
                { name: "Arts &amp; crafts session", cost: "¬£2", stars: 25 },
                { name: "Water balloon fight (summer)", cost: "¬£2", stars: 25 },
                { name: "Special baking session together", cost: "¬£3", stars: 28 },
                { name: "Library trip + ice cream", cost: "¬£4", stars: 28 },
                { name: "Small toy from pound shop", cost: "¬£1", stars: 30 }
            ],
            parentsRewards: [
                { name: "Kids make you a card/drawing", stars: 15 },
                { name: "Kids tidy the living room", stars: 20 },
                { name: "Choose what to watch on TV", stars: 20 },
                { name: "Kids do your chores for the day", stars: 25 },
                { name: "Breakfast in bed made by kids", stars: 28 },
                { name: "No nagging from kids for a day", stars: 30 },
                { name: "Sleep in on weekend (kids entertain themselves)", stars: 30 }
            ],
            // Star tracking for kids and parents (person -> habit -> day)
            kidsStars: {},
            parentsStars: {},
            parentsVisible: true
        };

        // Initialize star data
        function initializeStars() {
            chartData.children.forEach((child, childIndex) => {
                if (!chartData.kidsStars[childIndex]) {
                    chartData.kidsStars[childIndex] = {};
                }
                chartData.kidsHabits.forEach((habit, habitIndex) => {
                    if (!chartData.kidsStars[childIndex][habitIndex]) {
                        chartData.kidsStars[childIndex][habitIndex] = Array(7).fill(false);
                    }
                });
            });

            chartData.parents.forEach((parent, parentIndex) => {
                if (!chartData.parentsStars[parentIndex]) {
                    chartData.parentsStars[parentIndex] = {};
                }
                chartData.parentHabits.forEach((habit, habitIndex) => {
                    if (!chartData.parentsStars[parentIndex][habitIndex]) {
                        chartData.parentsStars[parentIndex][habitIndex] = Array(7).fill(false);
                    }
                });
            });
        }

        // ============================================
        // SUPABASE FUNCTIONS
        // ============================================

        // Load family members from Supabase
        async function loadFamilyMembers() {
            if (!supabase) return;

            try {
                const { data, error } = await supabase
                    .from('family_members')
                    .select('*')
                    .order('display_order');

                if (error) throw error;

                // Map members to familyMembers object
                data.forEach(member => {
                    familyMembers[member.name] = member.id;
                });

                console.log('‚úÖ Loaded family members:', familyMembers);
            } catch (error) {
                console.error('Error loading family members:', error);
            }
        }

        // Load star completions from Supabase
        async function loadStarCompletions() {
            if (!supabase) return;

            try {
                const { data, error } = await supabase
                    .from('star_completions')
                    .select('*');

                if (error) throw error;

                // Clear existing stars
                chartData.kidsStars = {};
                chartData.parentsStars = {};
                initializeStars();

                // Load stars from database
                data.forEach(completion => {
                    // Find which person and section this belongs to
                    const member = Object.entries(familyMembers).find(([name, id]) => id === completion.member_id);
                    if (!member) return;

                    const [memberName, memberId] = member;
                    const personIndex = chartData.children.findIndex(c => c.name === memberName);
                    const parentIndex = chartData.parents.findIndex(p => p.name === memberName);

                    if (personIndex >= 0) {
                        // It's a child
                        chartData.kidsStars[personIndex][completion.habit_index][completion.day_index] = completion.is_completed;
                    } else if (parentIndex >= 0) {
                        // It's a parent
                        chartData.parentsStars[parentIndex][completion.habit_index][completion.day_index] = completion.is_completed;
                    }
                });

                console.log('‚úÖ Loaded star completions from Supabase');
                renderCharts();
            } catch (error) {
                console.error('Error loading star completions:', error);
            }
        }

        // Save a star completion to Supabase
        async function saveStarToSupabase(section, personIndex, habitIndex, dayIndex, isCompleted) {
            if (!supabase) return;

            try {
                // Get the person's name
                const person = section === 'kids' ? chartData.children[personIndex] : chartData.parents[personIndex];
                const memberId = familyMembers[person.name];

                if (!memberId) {
                    console.error('Member ID not found for:', person.name);
                    return;
                }

                // Upsert (insert or update) the completion
                const { error } = await supabase
                    .from('star_completions')
                    .upsert({
                        member_id: memberId,
                        habit_index: habitIndex,
                        day_index: dayIndex,
                        is_completed: isCompleted,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'member_id,habit_index,day_index'
                    });

                if (error) throw error;

                console.log('üíæ Saved to Supabase:', person.name, habitIndex, dayIndex, isCompleted);
            } catch (error) {
                console.error('Error saving to Supabase:', error);
            }
        }

        // Toggle star for a person/habit/day
        async function toggleStar(section, personIndex, habitIndex, dayIndex) {
            const starsData = section === 'kids' ? chartData.kidsStars : chartData.parentsStars;
            starsData[personIndex][habitIndex][dayIndex] = !starsData[personIndex][habitIndex][dayIndex];

            const isCompleted = starsData[personIndex][habitIndex][dayIndex];

            // Show celebration animation
            if (isCompleted) {
                showCelebration();
            }

            // Save to Supabase
            await saveStarToSupabase(section, personIndex, habitIndex, dayIndex, isCompleted);

            renderCharts();
        }

        // Show celebration animation
        function showCelebration() {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.textContent = '‚≠ê';
            document.body.appendChild(celebration);
            
            setTimeout(() => {
                document.body.removeChild(celebration);
            }, 600);
        }

        // Calculate total stars for a person
        function calculateTotalStars(section, personIndex) {
            const starsData = section === 'kids' ? chartData.kidsStars : chartData.parentsStars;
            const habitsCount = section === 'kids' ? chartData.kidsHabits.length : chartData.parentHabits.length;
            
            let total = 0;
            for (let habitIndex = 0; habitIndex < habitsCount; habitIndex++) {
                if (starsData[personIndex] && starsData[personIndex][habitIndex]) {
                    total += starsData[personIndex][habitIndex].filter(star => star).length;
                }
            }
            return total;
        }

        // Get next reward milestone
        function getNextMilestone(stars, isParent = false) {
            const rewards = isParent ? chartData.parentsRewards : chartData.kidsRewards;
            const milestones = [...new Set(rewards.map(r => r.stars))].sort((a, b) => a - b);
            
            for (let milestone of milestones) {
                if (stars < milestone) {
                    return milestone;
                }
            }
            return milestones[milestones.length - 1];
        }

        // Generate person card HTML
        function generatePersonCard(person, personIndex, section) {
            const habits = section === 'kids' ? chartData.kidsHabits : chartData.parentHabits;
            const starsData = section === 'kids' ? chartData.kidsStars : chartData.parentsStars;
            const totalStars = calculateTotalStars(section, personIndex);
            const nextMilestone = getNextMilestone(totalStars, section === 'parents');
            const progressPercent = Math.min((totalStars / nextMilestone) * 100, 100);

            let cardHTML = `
                <div class="child-card ${person.className}">
                    <div class="child-header">
                        <div class="child-name">${person.name}</div>
                        <div class="child-total">${totalStars} ‚≠ê</div>
                    </div>
                    
                    <div class="days-header">
                        <div></div>
                        ${chartData.days.map(day => `<div class="day-label">${day}</div>`).join('')}
                    </div>
                    
                    <div class="habits-grid">
            `;

            habits.forEach((habit, habitIndex) => {
                cardHTML += `
                    <div class="habit-row">
                        <div class="habit-name">${habit}</div>
                `;
                
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const isStarred = starsData[personIndex] && starsData[personIndex][habitIndex] && starsData[personIndex][habitIndex][dayIndex];
                    cardHTML += `
                        <button class="star-btn ${isStarred ? 'filled' : 'empty'}" 
                                onclick="toggleStar('${section}', ${personIndex}, ${habitIndex}, ${dayIndex})">
                            ${isStarred ? '‚òÖ' : '‚òÜ'}
                        </button>
                    `;
                }
                
                cardHTML += `</div>`;
            });

            cardHTML += `
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                    <div class="progress-text">${totalStars} / ${nextMilestone} stars to next reward</div>
                </div>
            `;

            return cardHTML;
        }

        // Render all charts
        function renderCharts() {
            // Render kids chart
            const kidsGrid = document.getElementById('kidsGrid');
            kidsGrid.innerHTML = chartData.children.map((child, index) => 
                generatePersonCard(child, index, 'kids')
            ).join('');

            // Render parents chart
            const parentsGrid = document.getElementById('parentsGrid');
            parentsGrid.innerHTML = chartData.parents.map((parent, index) => 
                generatePersonCard(parent, index, 'parents')
            ).join('');

            // Update rewards
            updateRewardsDisplay();
        }

        // Update rewards display
        function updateRewardsDisplay() {
            const kidsRewardsDiv = document.getElementById('kidsRewards');
            const parentsRewardsDiv = document.getElementById('parentsRewards');

            kidsRewardsDiv.innerHTML = chartData.kidsRewards.map(reward => `
                <div class="reward-item">
                    <div class="reward-info">
                        <div class="reward-name">${reward.name}</div>
                        <div class="reward-cost">${reward.cost}</div>
                    </div>
                    <div class="reward-stars">${reward.stars} ‚≠ê</div>
                </div>
            `).join('');

            parentsRewardsDiv.innerHTML = chartData.parentsRewards.map(reward => `
                <div class="reward-item">
                    <div class="reward-info">
                        <div class="reward-name">${reward.name}</div>
                    </div>
                    <div class="reward-stars">${reward.stars} ‚≠ê</div>
                </div>
            `).join('');
        }

        // Toggle parents section visibility
        function toggleParentsSection() {
            const parentsContent = document.getElementById('parentsContent');
            chartData.parentsVisible = !chartData.parentsVisible;
            parentsContent.classList.toggle('hidden', !chartData.parentsVisible);
        }

        // Show rewards modal
        function showRewards() {
            document.getElementById('rewardsOverlay').style.display = 'flex';
        }

        // Hide rewards modal
        function hideRewards(event) {
            if (!event || event.target === document.getElementById('rewardsOverlay')) {
                document.getElementById('rewardsOverlay').style.display = 'none';
            }
        }

        // Show settings modal
        function showSettings() {
            // Update input values
            document.getElementById('child1Name').value = chartData.children[0].name;
            document.getElementById('child2Name').value = chartData.children[1].name;
            document.getElementById('child3Name').value = chartData.children[2].name;
            
            document.getElementById('settingsOverlay').style.display = 'flex';
        }

        // Hide settings modal
        function hideSettings(event) {
            if (!event || event.target === document.getElementById('settingsOverlay')) {
                document.getElementById('settingsOverlay').style.display = 'none';
            }
        }

        // Save settings
        function saveSettings() {
            chartData.children[0].name = document.getElementById('child1Name').value;
            chartData.children[1].name = document.getElementById('child2Name').value;
            chartData.children[2].name = document.getElementById('child3Name').value;
            
            renderCharts();
            hideSettings();
        }

        // Start new week
        async function newWeek() {
            if (confirm('Are you sure you want to start a new week? This will reset all stars!')) {
                // Reset all star data locally
                chartData.kidsStars = {};
                chartData.parentsStars = {};
                initializeStars();

                // Reset in Supabase if connected
                if (supabase) {
                    try {
                        // Delete all star completions
                        const { error } = await supabase
                            .from('star_completions')
                            .delete()
                            .neq('id', '00000000-0000-0000-0000-000000000000'); // Delete all rows

                        if (error) throw error;
                        console.log('‚úÖ Reset week in Supabase');
                    } catch (error) {
                        console.error('Error resetting week:', error);
                    }
                }

                renderCharts();

                // Update week display
                const now = new Date();
                const monday = new Date(now.setDate(now.getDate() - now.getDay() + 1));
                const sunday = new Date(monday);
                sunday.setDate(monday.getDate() + 6);

                const formatDate = (date) => {
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                                  'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    return `${months[date.getMonth()]} ${date.getDate()}`;
                };

                document.getElementById('weekDisplay').textContent =
                    `Week of ${formatDate(monday)} - ${formatDate(sunday)}, ${monday.getFullYear()}`;
            }
        }

        // Initialize the app
        async function initializeApp() {
            initializeStars();

            // Load data from Supabase if configured
            if (supabase) {
                await loadFamilyMembers();
                await loadStarCompletions();
            } else {
                // Just render with empty data
                renderCharts();
            }

            // Set current week display
            const now = new Date();
            const monday = new Date(now.setDate(now.getDate() - now.getDay() + 1));
            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            const formatDate = (date) => {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                              'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${months[date.getMonth()]} ${date.getDate()}`;
            };

            document.getElementById('weekDisplay').textContent =
                `Week of ${formatDate(monday)} - ${formatDate(sunday)}, ${monday.getFullYear()}`;
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>